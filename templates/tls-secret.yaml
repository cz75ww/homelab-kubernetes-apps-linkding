- name: Create the private key
  community.crypto.openssl_privatekey:
    path: "{{ .values.tlsdir }}/tls.key"
    size: 2048

- name: Generate CSR
  community.crypto.openssl_csr_pipe:
    privatekey_path: "{{ .values.tlsdir }}/tls.key"
    common_name: studyk8s.com
    organization_name: studyk8s.com
    digest: sha256
    subject_alt_name:
      - "DNS:{{ .values.dnsName }}"
  register: csr

- name: Create self-signed certificate from CSR
  community.crypto.x509_certificate:
    path: "{{ .values.tlsdir }}/tls.crt"
    csr_content: "{{ csr.csr }}"
    privatekey_path: {{ .values.tlsdir }}/tls.key"
    provider: selfsigned
    selfsigned_not_after: "+365d"

- name: Slurp private key
  slurp:
    src: "{{ .values.tlsdir }}/tls.key"
  register: key_file

- name: Slurp certificate
  slurp:
    src: "{{ .values.tlsdir }}/tls.crt"
  register: crt_file

- name: Create TLS secret in Kubernetes
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: tls-secret
        namespace: linkding-ns
      type: kubernetes.io/tls
      data:
        tls.key: "{{ key_file.content }}"
        tls.crt: "{{ crt_file.content }}"